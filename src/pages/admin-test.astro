---
// P√°gina de teste do admin migrada para Supabase
---

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Test - Supabase</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .status-box {
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .status-info {
            background: #e8f4fd;
            border-left-color: #3498db;
            color: #2c3e50;
        }

        .status-success {
            background: #d4edda;
            border-left-color: #27ae60;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border-left-color: #e74c3c;
            color: #721c24;
        }

        .test-section {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
        }

        .test-section:last-child {
            border-bottom: none;
        }

        .test-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:active {
            transform: translateY(1px);
        }

        ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        li {
            margin: 5px 0;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }

        #debug-info {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>üß™ Teste de Conectividade - Supabase</h1>
            <p>P√°gina de diagn√≥stico do sistema administrativo</p>
        </div>

        <div id="supabase-status" class="status-box status-info">
            <strong>Status:</strong> Verificando conex√£o com Supabase...
        </div>

        <div class="test-section">
            <h3>üîç Informa√ß√µes de Debug</h3>
            <div id="debug-info">
                <p>Carregando informa√ß√µes...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>üîê Teste de Autentica√ß√£o</h3>
            <p>Use as credenciais padr√£o para testar o login:</p>
            <ul>
                <li><strong>Email:</strong> admin@italo.dev</li>
                <li><strong>Senha:</strong> Italo2025Admin!</li>
            </ul>
            <button class="btn" onclick="testLogin()">Testar Login</button>
            <button class="btn" onclick="testLogout()">Testar Logout</button>
            <div id="auth-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Teste de Database</h3>
            <button class="btn" onclick="testDatabase()">Testar Conex√£o BD</button>
            <button class="btn" onclick="loadTestData()">Carregar Dados de Teste</button>
            <div id="db-result"></div>
        </div>

        <div class="test-section">
            <h3>üöÄ Acesso ao Admin</h3>
            <p>Se os testes passaram, voc√™ pode acessar:</p>
            <a href="/admin/" class="btn">üîó Ir para Admin Dashboard</a>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        console.log('üß™ Iniciando testes do Supabase...');

        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://nattvkjaecceirxthizc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hdHR2a2phZWNjZWlyeHRoaXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MjM2NTMsImV4cCI6MjA3MjQ5OTY1M30.K6Nfu5oGeoo6bZyToBNWkBdA1CncXEjWIrSydlMU2WQ';

        // Inicializar cliente
        let supabase = window.supabase;

        // Elementos DOM
        const statusDiv = document.getElementById('supabase-status');
        const debugInfo = document.getElementById('debug-info');
        const authResult = document.getElementById('auth-result');
        const dbResult = document.getElementById('db-result');

        function updateStatus(message: string, type: string = 'info') {
            if (statusDiv) {
                statusDiv.className = `status-box status-${type}`;
                statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
            }
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateDebug(info: unknown) {
            // Type guard para objeto
            const safeInfo = typeof info === 'object' && info !== null ? info : { value: String(info) };
            if (debugInfo) {
                debugInfo.innerHTML = `
                    <pre>${JSON.stringify(safeInfo, null, 2)}</pre>
                `;
            }
        }

        // Inicializa√ß√£o
        async function initialize() {
            try {
                updateStatus('üîÑ Inicializando Supabase...', 'info');

                // Verificar se o cliente Supabase est√° dispon√≠vel
                if (!window.supabase) {
                    throw new Error('Cliente Supabase n√£o inicializado');
                }

                supabase = window.supabase;

                // Teste b√°sico de conectividade
                const { data, error } = await supabase.auth.getSession();

                if (error && error.message !== 'session_not_found') {
                    throw error;
                }

                updateStatus('‚úÖ Conectado com Supabase com sucesso!', 'success');

                updateDebug({
                    timestamp: new Date().toISOString(),
                    supabase_url: SUPABASE_URL,
                    sdk_version: 'v2 (latest)',
                    session_status: data?.session ? 'Logado' : 'N√£o logado',
                    connection_test: '‚úÖ Passou'
                });

            } catch (error: unknown) {
                let message = 'Erro desconhecido';
                if (error instanceof Error) message = error.message;
                else if (typeof error === 'string') message = error;
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                updateStatus(`‚ùå Erro: ${message}`, 'error');
                updateDebug({
                    error: message,
                    timestamp: new Date().toISOString(),
                    status: 'Falha na inicializa√ß√£o'
                });
            }
        }

        // Teste de login
        async function testLogin() {
            if (authResult) authResult.innerHTML = '<p>üîÑ Testando login...</p>';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@italo.dev',
                    password: 'Italo2025Admin!'
                });

                if (error) {
                    if (authResult) authResult.innerHTML = `<div class="status-box status-error">‚ùå Erro no login: ${error.message}</div>`;
                    return;
                }

                if (authResult) authResult.innerHTML = `
                    <div class="status-box status-success">
                        ‚úÖ Login realizado com sucesso!<br>
                        <strong>Usu√°rio:</strong> ${data.user?.email}<br>
                        <strong>ID:</strong> ${data.user?.id}
                    </div>
                `;

            } catch (error: unknown) {
                let message = 'Erro desconhecido';
                if (error instanceof Error) message = error.message;
                else if (typeof error === 'string') message = error;
                if (authResult) authResult.innerHTML = `<div class="status-box status-error">‚ùå Erro interno: ${message}</div>`;
            }
        }

        // Teste de logout
        async function testLogout() {
            if (authResult) authResult.innerHTML = '<p>üîÑ Testando logout...</p>';

            try {
                const { error } = await supabase.auth.signOut();

                if (error) {
                    if (authResult) authResult.innerHTML = `<div class="status-box status-error">‚ùå Erro no logout: ${error.message}</div>`;
                    return;
                }

                if (authResult) authResult.innerHTML = `<div class="status-box status-success">‚úÖ Logout realizado com sucesso!</div>`;

            } catch (error: unknown) {
                let message = 'Erro desconhecido';
                if (error instanceof Error) message = error.message;
                else if (typeof error === 'string') message = error;
                if (authResult) authResult.innerHTML = `<div class="status-box status-error">‚ùå Erro interno: ${message}</div>`;
            }
        }

        // Teste de database
        async function testDatabase() {
            if (dbResult) dbResult.innerHTML = '<p>üîÑ Testando conex√£o com database...</p>';

            try {
                // Tentar listar posts
                const { data: posts, error: postsError } = await supabase
                    .from('posts')
                    .select('id, title, created_at')
                    .limit(5);

                // Tentar listar projetos
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('id, title, created_at')
                    .limit(5);

                let result = '<div class="status-box status-success">‚úÖ Conex√£o com database OK!</div>';

                result += `<h4>üìù Posts (${posts?.length || 0}):</h4>`;
                if (postsError) {
                    result += `<p style="color: orange;">‚ö†Ô∏è ${postsError.message}</p>`;
                } else if (posts?.length > 0) {
                    result += '<ul>';
                    posts.forEach((post: { title: string; created_at: string }) => {
                        result += `<li>${post.title} (${new Date(post.created_at).toLocaleDateString()})</li>`;
                    });
                    result += '</ul>';
                } else {
                    result += '<p>Nenhum post encontrado</p>';
                }

                result += `<h4>üöÄ Projetos (${projects?.length || 0}):</h4>`;
                if (projectsError) {
                    result += `<p style="color: orange;">‚ö†Ô∏è ${projectsError.message}</p>`;
                } else if (projects?.length > 0) {
                    result += '<ul>';
                    projects.forEach((project: { title: string; created_at: string }) => {
                        result += `<li>${project.title} (${new Date(project.created_at).toLocaleDateString()})</li>`;
                    });
                    result += '</ul>';
                } else {
                    result += '<p>Nenhum projeto encontrado</p>';
                }

                if (dbResult) dbResult.innerHTML = result;

            } catch (error: unknown) {
                let message = 'Erro desconhecido';
                if (error instanceof Error) message = error.message;
                else if (typeof error === 'string') message = error;
                if (dbResult) dbResult.innerHTML = `<div class="status-box status-error">‚ùå Erro no database: ${message}</div>`;
            }
        }

        // Carregar dados de teste
        async function loadTestData() {
            if (dbResult) dbResult.innerHTML = '<p>üîÑ Criando dados de teste...</p>';

            try {
                // Criar post de teste
                const { data: postData, error: postError } = await supabase
                    .from('posts')
                    .insert([
                        {
                            title: 'Post de Teste - Supabase',
                            slug: 'post-de-teste-supabase',
                            excerpt: 'Este √© um post de teste criado automaticamente para verificar a funcionalidade do Supabase.',
                            content: '# Post de Teste\n\nEste post foi criado automaticamente pelo sistema de testes para verificar se o **Supabase** est√° funcionando corretamente.\n\n## Features testadas:\n- ‚úÖ Conex√£o com database\n- ‚úÖ Inser√ß√£o de dados\n- ‚úÖ Autentica√ß√£o',
                            tags: ['teste', 'supabase', 'desenvolvimento'],
                            status: 'published',
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();

                // Criar projeto de teste
                const { data: projectData, error: projectError } = await supabase
                    .from('projects')
                    .insert([
                        {
                            title: 'Projeto de Teste - Supabase',
                            description: 'Projeto de teste criado automaticamente para verificar a integra√ß√£o com Supabase.',
                            technologies: ['Astro', 'Supabase', 'JavaScript'],
                            demo_link: 'https://exemplo.com',
                            github_link: 'https://github.com/seu-dev-br/portifolio',
                            status: 'published',
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();

                let result = '<div class="status-box status-success">‚úÖ Dados de teste criados!</div>';

                if (postError) {
                    result += `<p style="color: orange;">‚ö†Ô∏è Erro no post: ${postError.message}</p>`;
                } else {
                    result += `<p>‚úÖ Post criado: ${postData[0]?.title}</p>`;
                }

                if (projectError) {
                    result += `<p style="color: orange;">‚ö†Ô∏è Erro no projeto: ${projectError.message}</p>`;
                } else {
                    result += `<p>‚úÖ Projeto criado: ${projectData[0]?.title}</p>`;
                }

                if (dbResult) dbResult.innerHTML = result;

            } catch (error: unknown) {
                let message = 'Erro desconhecido';
                if (error instanceof Error) message = error.message;
                else if (typeof error === 'string') message = error;
                if (dbResult) dbResult.innerHTML = `<div class="status-box status-error">‚ùå Erro ao criar dados: ${message}</div>`;
            }
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
